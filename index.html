<p>No data is stored, 1 request is made to Queslar with your api key and all calculations happen locally.</p>
<table>
<tr><td><label for="apikey">API key: </label></td><td><input type="text" name="apikey" id="apikey" /></td></tr>
<tr><td><label for="petstrength">% Strength pet passive: </label></td><td><input type="number" name="petstrength" value="1" id="petstrength" /></td></tr>
<tr><td><label for="pethealth">% Health pet passive: </label></td><td><input type="number" name="pethealth" value="1" id="pethealth" /></td></tr>
<tr><td><label for="petagility">% Agility pet passive: </label></td><td><input type="number" name="petagility" value="1" id="petagility" /></td></tr>
<tr><td><label for="petdexterity">% Dexterity pet passive: </label></td><td><input type="number" name="petdexterity" value="1" id="petdexterity" /></td></tr>
</table>
<button onclick="startSim()">Simulate</button> (Press only once and give it some time)
<p>You can 100% win against: <span id="personalResult"></span></p>
<script>

var simulationAmount = 6;
var currentSimulation = 0;
var combatResult = 0;

function startSim() {
    sendRequest("https://queslar.com/api/player/full/" + document.getElementById("apikey").value, simulatePersonalStrength);
}

function sendRequest(theUrl, callback)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
            callback(JSON.parse(xmlHttp.responseText));
        }
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
    xmlHttp.send(null);
}

function simulatePersonalStrength(player) {
    var playerStats = initStats();
    playerStats["strength"] += player.stats.strength;
    playerStats["health"] += player.stats.health;
    playerStats["agility"] += player.stats.agility;
    playerStats["dexterity"] += player.stats.dexterity;
    playerStats["critchance"] += player.boosts.critChance * 0.1 + player.house.chairs;
    playerStats["critdamage"] += player.boosts.critDamage * 0.1 + player.house.stove;
    playerStats["multistrike"] += player.boosts.multistrike * 0.1 + player.house.sink;
    playerStats["healing"] += player.boosts.healing * 0.1 + player.house.basket;
    player.equipmentEquipped.forEach(function(equipment) {
        addEquipmentStats(playerStats, equipment, getSlot(player.equipmentSlots, equipment.item_type));
    });
    player.partners.forEach(function(partner) {
        playerStats["strength"] += partner.strength;
        playerStats["health"] += partner.health;
        playerStats["agility"] += partner.agility;
        playerStats["dexterity"] += partner.dexterity;
    });
    var mobModifiers = {"strength": 0, "health": 0, "agility": 0, "dexterity": 0};
    var strengthPassive = 1 + parseInt(document.getElementById("petstrength").value) / 100;
    var healthPassive = 1 + parseInt(document.getElementById("pethealth").value) / 100;
    var agilityPassive = 1 + parseInt(document.getElementById("petagility").value) / 100;
    var dexterityPassive = 1 + parseInt(document.getElementById("petdexterity").value) / 100;
    player.pets.forEach(function(pet) {
        var efficiency = 0.5 + (0.05 * pet.efficiency_tier);
        playerStats["damage"] += pet.level * 4 * efficiency;
        playerStats["defense"] += pet.level * 2 * efficiency;
        playerStats["strength"] += pet.strength * efficiency;
        playerStats["health"] += pet.health * efficiency;
        playerStats["agility"] += pet.agility * efficiency;
        playerStats["dexterity"] += pet.dexterity * efficiency;
        mobModifiers["strength"] += pet.monster_strength * 8 * strengthPassive * efficiency;
        mobModifiers["health"] += pet.monster_health * 4 * healthPassive * efficiency;
        mobModifiers["agility"] += pet.monster_agility * 12 * agilityPassive * efficiency;
        mobModifiers["dexterity"] += pet.monster_dexterity * 12 * dexterityPassive * efficiency;
    });
    playerStats["defense"] *= 1 + player.boosts.defense / 1000;
    console.log(playerStats);
    console.log(mobModifiers);
    combatResult = 0;
    currentSimulation = 0;
    simulateCombat(playerStats, null, mobModifiers, document.getElementById("personalResult"));
}

function addEquipmentStats(playerStats, equipment, slot) {
    var slotMulti = 1+slot/100;
    playerStats["damage"] += equipment.damage * slotMulti;
    playerStats["defense"] += equipment.defense * slotMulti;
    playerStats["strength"] += equipment.strength * slotMulti;
    playerStats["health"] += equipment.health * slotMulti;
    playerStats["agility"] += equipment.agility * slotMulti;
    playerStats["dexterity"] += equipment.dexterity * slotMulti;
}

function getSlot(slots, equipmentType) {
    switch (equipmentType) {
        case "weapon":
            return slots.left_hand_level;
        case "dagger":
        case "shield":
            return slots.right_hand_level;
        case "helmet":
            return slots.head_level;
        case "armor":
            return slots.body_level;
        case "gloves":
            return slots.hands_level;
        case "leggings":
            return slots.legs_level;
        case "boots":
            return slots.feet_level;
        default:
            return 0;
    }
}

function simulateCombat(playerStats, statsToCheck, mobModifiers, resultSpan) {
    var beatableEnemyStats = null;
    if (statsToCheck == null) {
        statsToCheck = simulateCombatFast(playerStats, mobModifiers);
    }
    var highestWin = 0;
    var attempts = 0;
    var simulations = 100;
    var up = 1.1;
    var down = 0.97;
    var allowedDeaths = 0;
    var player = new Object();
    player.damage = playerStats["damage"] + playerStats["strength"];
    player.health = playerStats["health"] * 50;
    player.maxHealth = player.health;
    player.healing = player.health * 0.025;
    player.critDmg = (playerStats["critdamage"] + 20) / 100;
    while (beatableEnemyStats == null) {
        var mobStats = getMobStats(statsToCheck, mobModifiers);
        player.hit = playerStats["dexterity"] / (playerStats["dexterity"] + mobStats["agility"]) * 100;
        var deaths = 0;
        var playerWins = null;
        var mob = new Object();
        mob.damage = mobStats["strength"] - playerStats["defense"];
        mob.health = mobStats["health"] * 50;
        mob.hit = mobStats["dexterity"] / (mobStats["dexterity"] + playerStats["agility"]) * 100;
        if (mob.damage <= 0) {
            playerWins = true;
        } else if (player.damage <= 0) {
            playerWins = false;
        }
        if (playerWins == null) {
            for (var i = 0; i < simulations; i++) {
                var fight = new Object();
                fight.player = Object.create(player);
                fight.mob = Object.create(mob);
                while (fight.player.health > 0 && fight.mob.health > 0) {
                    var hits = 1 + getHits(playerStats["multistrike"]);
                    for (var j = 0; j < hits; j++) {
                        if (getRandom() <= player.hit) {
                            fight.mob.health -= getDamage(player.damage, playerStats["critchance"], player.critDmg);
                        }
                    }
                    if (getRandom() <= mob.hit) {
                        fight.player.health -= mob.damage;
                    }
                    var heals = getHits(playerStats["healing"]);
                    for (j = 0; j < heals; j++) {
                        fight.player.health += fight.player.healing;
                        fight.player.healing *= 0.99;
                        if (fight.player.health > fight.player.maxHealth) {
                            fight.player.health = fight.player.maxHealth;
                        }
                    }
                }
                if (fight.mob.health > 0) {
                    deaths++;
                    if (deaths > allowedDeaths) {
                        playerWins = false;
                        break;
                    }
                }
            }
        }
        if (playerWins == null || playerWins) {
            if (highestWin != null && highestWin == statsToCheck) {
                beatableEnemyStats = highestWin;
            }
            if (simulations >= 1000) {
                highestWin = statsToCheck;
                down = 0.99
            }
            statsToCheck *= up;
        } else {
            if (statsToCheck == highestWin) {
                highestWin = null;
            }
            statsToCheck *= down;
            if (simulations < 1000) {
                up = 1.01;
                simulations = 1000;
            }
            if (highestWin != null && statsToCheck < highestWin) {
                statsToCheck = highestWin;
            }
        }
        attempts++;
    }
    currentSimulation++;
    if (currentSimulation >= simulationAmount) {
        combatResult += beatableEnemyStats;
        resultSpan.innerHTML += convertStatToMob(combatResult/simulationAmount);
    } else {
        combatResult += beatableEnemyStats;
        simulateCombat(playerStats, beatableEnemyStats, mobModifiers, resultSpan);
    }
}

function simulateCombatFast(playerStats, mobModifiers) {
    var beatableEnemyStats = null;
    var statsToCheck = Math.round((playerStats["strength"] + playerStats["health"] + playerStats["agility"] + playerStats["dexterity"]) / 4);
    var highestWin = 0;
    var attempts = 0;
    var allowedDeaths = 0;
    while (beatableEnemyStats == null) {
        var deaths = 0;
        var playerWins = null;
        var player = new Object();
        var critDmg = (1+playerStats["critchance"]/100)*((playerStats["critdamage"]+20)/100);
        var hit = playerStats["dexterity"] / (playerStats["dexterity"] + statsToCheck) * 100;
        player.damage = (playerStats["damage"] + playerStats["strength"]) * critDmg * (hit/100) * (playerStats["multistrike"]/100);
        player.health = playerStats["health"] * 50;
        player.healing = player.health * 0.025;
        var mobStats = getMobStats(statsToCheck, mobModifiers);
        var mob = new Object();
        mob.damage = mobStats["strength"] - playerStats["defense"];
        mob.health = mobStats["health"] * 50;
        mob.damage *= mobStats["dexterity"]/(mobStats["dexterity"]+playerStats["agility"]);
        if (mob.damage <= 0) {
            playerWins = true;
        } else if (player.damage <= 0) {
            playerWins = false;
        }
        if (playerWins == null) {
            var hits = Math.min(mob.health / player.damage, player.health / mob.damage);
            if (mob.health / player.damage > (player.health + (player.healing * (playerStats["healing"]/100) * hits)) / mob.damage) {
                playerWins = false;
            }
        }
        if (playerWins == null || playerWins) {
            highestWin = statsToCheck;
            statsToCheck *= 1.02;
        } else {
            statsToCheck *= 0.99;
            if (statsToCheck <= highestWin) {
                beatableEnemyStats = highestWin;
            }
        }
        attempts++;
    }
      return beatableEnemyStats;
}

function initStats() {
    var stats = ["damage", "defense", "strength", "health", "agility", "dexterity", "critchance", "critdamage", "multistrike", "healing"];
    var statArray = [];
    stats.forEach(function(stat) {
      statArray[stat] = 0;     
    });
    return statArray;
}

function getMobStats(statsToCheck, mobModifiers) {
    var stats = [];
    stats["strength"] = statsToCheck - mobModifiers["strength"];
    stats["health"] = statsToCheck - mobModifiers["health"];
    stats["agility"] = statsToCheck - mobModifiers["agility"];
    stats["dexterity"] = statsToCheck - mobModifiers["dexterity"];
    return stats;
}

function getHits(percentage) {
    var hits = 0;
    while (percentage >= 100) {
        hits++;
        percentage -= 100;
    }
    if (percentage > 0 && getRandom() <= percentage) {
        hits++;
    }
    return hits;
}

function getDamage(baseDamage, critChance, critDamage) {
    var crits = getHits(critChance);
    if (crits > 0) {
        baseDamage *= 1 + (crits * critDamage);
    }
    return baseDamage;
}

function getRandom() {
   return Math.floor(Math.random() * 100) + 0.01;
}

function convertStatToMob(stat) {
    var mob = 1;
    for (var x = 1000; x >= 1; x /= 10) {
        mob = approximateMob(mob, stat, x);
    }
    return "a" + (1+Math.floor(mob/100)) + "m" + ((mob-Math.floor(mob/100)*100)%101);
}

function approximateMob(currentMob, targetStat, increment) {
    while (currentMob < 1000000) {
        var currentStat = 1+Math.pow(10*(currentMob-1),1.25);
        if (currentMob > 100) {
            currentStat *= Math.log(currentMob/100)+1;
        }
        for (var x = 500; x <= 900; x += 200) {
            if (currentMob > x) {
                currentStat *= Math.log(currentMob/x)+1;
            }
        }
        for (var x = 1000; x <= 1800; x += 100) {
            if (currentMob > x) {
                currentStat *= Math.log(currentMob/x)+1;
            }
        }
        if (currentStat > targetStat) {
            return currentMob-increment;
        }
        currentMob += increment;
    }
}
</script>
