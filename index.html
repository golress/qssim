<html>
<head>
</head>
<body>
    <table>
        <tbody>
            <tr><td><u>Stats:</u></td><td></td></tr>
            <tr><td><label for="damage">Damage: </label></td><td><input name="damage" value="0" id="damage" type="number"/></td></tr>
            <tr><td><label for="defense">Defense: </label></td><td><input name="defense" value="0" id="defense" type="number"/></td></tr>
            <tr><td><label for="strength">Strength: </label></td><td><input name="strength" value="0" id="strength" type="number"/></td></tr>
            <tr><td><label for="health">Health: </label></td><td><input name="health" value="0" id="health" type="number"/></td></tr>
            <tr><td><label for="agility">Agility: </label></td><td><input name="agility" value="0" id="agility" type="number"/></td></tr>
            <tr><td><label for="dexterity">Dexterity: </label></td><td><input name="dexterity" value="0" id="dexterity" type="number"/></td></tr>
            <tr><td><label for="chc">Crit Chance %: </label></td><td><input name="chc" step="0.1" value="0" id="chc" type="number"/></td></tr>
            <tr><td><label for="chd">Crit Damage %: </label></td><td><input name="chd" step="0.1" value="0" id="chd" type="number"/></td></tr>
            <tr><td><label for="multistrike">Multistrike %: </label></td><td><input name="multistrike" step="0.1" value="0" id="multistrike" type="number"/></td></tr>
            <tr><td><label for="healing">Healing %: </label></td><td><input name="healing" step="0.1" value="0" id="healing" type="number"/></td></tr>
            <tr><td><u>Settings:</u></td><td></td></tr>
            <tr><td><label for="simulations">Simulations: </label></td><td><input name="simulations" step="1" value="1000" id="simulations" type="number"/></td></tr>
            <tr><td><label for="deaths">Allowed deaths: </label></td><td><input name="deaths" step="1" value="1" id="deaths" type="number"/></td></tr>
        </tbody>
    </table>
<button onclick="simulateCombat()">Simulate</button>

<div id="simulationResult"></div>
</body>
</html>

<script>
var stats = ["damage", "defense", "strength", "health", "agility", "dexterity", "chc", "chd", "multistrike", "healing"];
function simulateCombat(playerStats) {
    var playerStats = [];
    stats.forEach(function(statName) {
        playerStats.push(parseFloat(document.getElementById(statName).value));
    });
    for (var i = 6; i <= 9; i++) {
        playerStats[i] *= 100;   
    }
    var beatableEnemyStats = null;
    var statsToCheck = Math.round((playerStats[2] + playerStats[3] + playerStats[4] + playerStats[5]) / 4) * 1.3;
    var highestWin = 0;
    var attempts = 0;
    var simulations = parseInt(document.getElementById("simulations").value);
    var allowedDeaths = parseInt(document.getElementById("deaths").value);
    var up = 1.1;
    var player = new Object();
    player.damage = playerStats[0] + playerStats[2];
    player.health = playerStats[3] * 50;
    player.maxHealth = player.health;
    player.healing = player.health * 0.025;
    player.critDmg = (playerStats[7] + 2000) / 10000;
    while (beatableEnemyStats == null && attempts < 100) {
        player.hit = playerStats[5]/(playerStats[5]+statsToCheck) * 10000;
        var deaths = 0;
        var playerWins = null;
        var mob = new Object();
        mob.damage = statsToCheck - playerStats[1];
        mob.health = statsToCheck * 50;
        mob.hit = 10000 - player.hit;
        if (mob.damage <= 0) {
            playerWins = true;
        } else if (player.damage <= 0) {
            playerWins = false;
        }
        if (playerWins == null) {
            for (var i = 0; i < simulations; i++) {
                var fight = new Object();
                fight.player = Object.create(player);
                fight.mob = Object.create(mob);
                while (fight.player.health > 0 && fight.mob.health > 0) {
                    var hits = 1 + getHits(playerStats[8]);
                    for (var j = 0; j < hits; j++) {
                        if (getRandom() <= player.hit) {
                            fight.mob.health -= getDamage(player.damage, playerStats[6], player.critDmg);
                        }
                    }
                    if (getRandom() <= mob.hit) {
                        fight.player.health -= mob.damage;
                    }
                    var heals = getHits(playerStats[9]);
                    for (j = 0; j < heals; j++) {
                        fight.player.health += fight.player.healing;
                        fight.player.healing *= 0.99;
                        if (fight.player.health > fight.player.maxHealth) {
                            fight.player.health = fight.player.maxHealth;
                        }
                    }
                }
                if (fight.mob.health > 0) {
                    deaths++;
                    if (deaths >= allowedDeaths) {
                        playerWins = false;
                        break;
                    }
                }
            }
        }
        if (playerWins == null || playerWins) {
            highestWin = statsToCheck;
            statsToCheck *= up;
        } else {
            statsToCheck *= 0.99;
            up = 1.02;
            if (statsToCheck <= highestWin) {
                beatableEnemyStats = highestWin;
            }
        }
        attempts++;
    }
    document.getElementById("simulationResult").innerHTML = "<b>" + Math.round(beatableEnemyStats) + "</b>";
}

function getHits(percentage) {
    var hits = 0;
    while (percentage >= 10000) {
        hits++;
        percentage -= 10000;
    }
    if (percentage > 0 && getRandom() <= percentage) {
        hits++;
    }
    return hits;
}

function getDamage(baseDamage, critChance, critDamage) {
    var crits = getHits(critChance);
    if (crits > 0) {
        baseDamage *= 1 + (crits * critDamage);
    }
    return baseDamage;
}

function getRandom() {
   return Math.floor(Math.random() * 10000) + 1;
}
</script>
